# TP2 : Environnement virtuel

## 0. Prérequis

## I. Topologie réseau

### Compte-rendu

### ☀️ Sur node1.lan1.tp2

```
[antoine@node1 ~]$ ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:cd:01:d9 brd ff:ff:ff:ff:ff:ff
    inet 10.1.1.11/24 brd 10.1.1.255 scope global noprefixroute enp0s3
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fecd:1d9/64 scope link
       valid_lft forever preferred_lft forever
[antoine@node1 ~]$ ip route s
10.1.1.0/24 dev enp0s3 proto kernel scope link src 10.1.1.11 metric 100
10.1.2.0/24 via 10.1.1.254 dev enp0s3 proto static metric 100
[antoine@node1 ~]$ ping 10.1.2.12
PING 10.1.2.12 (10.1.2.12) 56(84) bytes of data.
64 bytes from 10.1.2.12: icmp_seq=1 ttl=63 time=3.16 ms
64 bytes from 10.1.2.12: icmp_seq=2 ttl=63 time=1.64 ms
^C
--- 10.1.2.12 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 1.640/2.401/3.162/0.761 ms
[antoine@node1 ~]$ traceroute 10.1.2.12
traceroute to 10.1.2.12 (10.1.2.12), 30 hops max, 60 byte packets
 1  10.1.1.254 (10.1.1.254)  0.815 ms  0.686 ms  0.728 ms
 2  10.1.2.12 (10.1.2.12)  1.739 ms !X  1.790 ms !X  1.955 ms !X
```

## II. Interlude accès internet

### Ajoutez une carte NAT au routeur pour qu'il ait un accès internet.
### ☀️ Sur router.tp2
```
[antoine@router ~]$ ping google.com
PING google.com (216.58.214.78) 56(84) bytes of data.
64 bytes from fra15s10-in-f78.1e100.net (216.58.214.78): icmp_seq=1 ttl=116 time=16.7 ms
64 bytes from fra15s10-in-f14.1e100.net (216.58.214.78): icmp_seq=2 ttl=116 time=20.7 ms
64 bytes from fra15s10-in-f78.1e100.net (216.58.214.78): icmp_seq=3 ttl=116 time=20.0 ms
^C
--- google.com ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2003ms
rtt min/avg/max/mdev = 16.745/19.155/20.677/1.723 ms
```

### ☀️ Accès internet LAN1 et LAN2

```
[antoine@node2 ~]$ cat /etc/sysconfig/network-scripts/route-enp0s3
default via 10.1.1.254 dev enp0s3
10.1.2.0/24 via 10.1.1.254 dev enp0s3
[antoine@node2 ~]$ cat /etc/resolv.conf
# Generated by NetworkManager
nameserver 1.1.1.1
search lan1.tp2
[antoine@node2 ~]$ ping 1.1.1.1
PING 1.1.1.1 (1.1.1.1) 56(84) bytes of data.
64 bytes from 1.1.1.1: icmp_seq=1 ttl=53 time=20.6 ms
64 bytes from 1.1.1.1: icmp_seq=2 ttl=53 time=19.7 ms
^C
--- 1.1.1.1 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 19.689/20.151/20.613/0.462 ms
[antoine@node2 ~]$ ping google.com
PING google.com (142.250.201.14) 56(84) bytes of data.
64 bytes from mrs08s19-in-f14.1e100.net (142.250.201.14): icmp_seq=1 ttl=112 time=18.3 ms
64 bytes from mrs08s19-in-f14.1e100.net (142.250.201.14): icmp_seq=2 ttl=112 time=21.6 ms
^C
--- google.com ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 18.267/19.927/21.588/1.660 ms
```

## III. Services réseau

### 1. Web web web

### ☀️ Sur web.lan2.tp2

```
[antoine@web ~]$ cat /etc/nginx/conf.d/site_nul.conf
server {
	listen 80;
	index index.html;
	server_name www.site_nul.b2;
	root /var/www/site_nul;
}
```

```
[antoine@web ~]$ sudo ss -antplu | grep nginx
tcp   LISTEN 0      511          0.0.0.0:80        0.0.0.0:*    users:(("nginx",pid=1017,fd=6),("nginx",pid=1016,fd=6))
tcp   LISTEN 0      511             [::]:80           [::]:*    users:(("nginx",pid=1017,fd=7),("nginx",pid=1016,fd=7))
```

```
[antoine@web ~]$ sudo firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: enp0s3
  sources:
  services: cockpit dhcpv6-client ssh
  ports: 22/tcp 80/tcp
  protocols:
  forward: yes
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```

### ☀️ Sur node1.lan1.tp2
```
[antoine@node1 ~]$ curl site_nul.tp2
 <!DOCTYPE html>
 <html>
	 <head>
		 <title>Title of the document</title>
	 </head>

	 <body>
		 The content of the document......
	 </body>

 </html>
```
## 2. Or is it ? Bonus : DHCP
### ☀️ Sur dhcp.lan1.tp2

```
[antoine@dhcp ~]$ ip a | grep enp0s3
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    inet 10.1.1.253/24 brd 10.1.1.255 scope global noprefixroute enp0s3
```

```
[antoine@dhcp ~]$ sudo dnf -y install dhcp-server
```

```
[antoine@dhcp ~]$ sudo cat /etc/dhcp/dhcpd.conf
[sudo] password for antoine:
option domain-name     "srv.world";
option domain-name-servers     1.1.1.1;
default-lease-time 600;
max-lease-time 7200;
authoritative;


subnet 10.1.1.0 netmask 255.255.255.0 {
    range dynamic-bootp 10.1.1.100 10.1.1.200;
    option broadcast-address 10.1.1.255;
    option routers 10.1.1.254;
}
```

```
[antoine@dhcp ~]$ systemctl status dhcpd
● dhcpd.service - DHCPv4 Server Daemon
     Loaded: loaded (/usr/lib/systemd/system/dhcpd.service; enabled; preset: disabled)
     Active: active (running) since Fri 2024-10-04 09:41:49 CEST; 3min 9s ago
       Docs: man:dhcpd(8)
             man:dhcpd.conf(5)
   Main PID: 747 (dhcpd)
     Status: "Dispatching packets..."
      Tasks: 1 (limit: 2674)
     Memory: 7.1M
        CPU: 10ms
     CGroup: /system.slice/dhcpd.service
             └─747 /usr/sbin/dhcpd -f -cf /etc/dhcp/dhcpd.conf -user dhcpd -group dhcpd --no-pid

Oct 04 09:41:49 dhcp.lan1.tp2 dhcpd[747]: Config file: /etc/dhcp/dhcpd.conf
Oct 04 09:41:49 dhcp.lan1.tp2 dhcpd[747]: Database file: /var/lib/dhcpd/dhcpd.leases
Oct 04 09:41:49 dhcp.lan1.tp2 dhcpd[747]: PID file: /var/run/dhcpd.pid
Oct 04 09:41:49 dhcp.lan1.tp2 dhcpd[747]: Source compiled to use binary-leases
Oct 04 09:41:49 dhcp.lan1.tp2 dhcpd[747]: Wrote 1 leases to leases file.
Oct 04 09:41:49 dhcp.lan1.tp2 dhcpd[747]: Listening on LPF/enp0s3/08:00:27:fd:63:ff/10.1.1.0/24
Oct 04 09:41:49 dhcp.lan1.tp2 dhcpd[747]: Sending on   LPF/enp0s3/08:00:27:fd:63:ff/10.1.1.0/24
Oct 04 09:41:49 dhcp.lan1.tp2 dhcpd[747]: Sending on   Socket/fallback/fallback-net
Oct 04 09:41:49 dhcp.lan1.tp2 dhcpd[747]: Server starting service.
Oct 04 09:41:49 dhcp.lan1.tp2 systemd[1]: Started DHCPv4 Server Daemon.
```

### ☀️ Sur node1.lan1.tp2

```
[antoine@node1 ~]$ cat /etc/sysconfig/network-scripts/ifcfg-enp0s3
DEVICE=enp0s3
BOOTPROTO=dhcp
ONBOOT=yes

[antoine@node1 ~]$ ping 10.1.2.11
PING 10.1.2.11 (10.1.2.11) 56(84) bytes of data.
64 bytes from 10.1.2.11: icmp_seq=1 ttl=63 time=1.93 ms
64 bytes from 10.1.2.11: icmp_seq=2 ttl=63 time=1.89 ms
^C
--- 10.1.2.11 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1002ms
rtt min/avg/max/mdev = 1.888/1.909/1.931/0.021 ms

[antoine@node1 ~]$ ip route
default via 10.1.1.254 dev enp0s3 proto static metric 100
default via 10.1.1.254 dev enp0s3 proto dhcp src 10.1.1.101 metric 100
10.1.1.0/24 dev enp0s3 proto kernel scope link src 10.1.1.101 metric 100
10.1.2.0/24 via 10.1.1.254 dev enp0s3 proto static metric 100

[antoine@node1 ~]$ sudo find / -name '*.lease' -exec grep -H "10.1.1.101" {} \;
/var/lib/NetworkManager/internal-3c36b8c2-334b-57c7-91b6-4401f3489c69-enp0s3.lease:ADDRESS=10.1.1.101
[antoine@node1 ~]$ sudo cat /var/lib/NetworkManager/internal-3c36b8c2-334b-57c7-91b6-4401f3489c69-enp0s3.lease
# This is private data. Do not parse.
ADDRESS=10.1.1.101
```